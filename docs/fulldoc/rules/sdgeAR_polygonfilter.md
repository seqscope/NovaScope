# Rule `sdgeAR_polygonfilter`:

## Purpose
The `sdgeAR_polygonfilter` filters the transcript-indexed spatial digital gene expression matrix (SGE) by UMI density.

## Input Files
* **Transcript-indexed SGE in TSV Format**
A transcript-indexed SGE in the FICTURE format, which is generated by Rule [`sdgeAR_reformat`](./sdgeAR_reformat.md).

* **A Tab-delimited Clean Feature File**
Required the clean feature file from Rule [`sdgeAR_featurefilter`](./sdgeAR_featurefilter.md).

* **A Metadata File for X Y Coordinates**
A meta file for the minimum and maximum X Y coordinates is required. This will be generated by Rule [`dge2sdgeAR`](./sdge2sdgeAR.md) or by the user manually.

## Output Files
The rule generates the following output in the specified directory path:
```
<output_directory>/analysis/<run_id>/<unit_id>/preprocess
```

Besides Unit ID, output files will contains the following two variables:

* `<solo_feature>`: Genomic feature of this SGE.
* `<feature_and_polygon_filtering>`: If polygon-filtering based on UMI density is enabled, `<feature_and_polygon_filtering>` will be `auto`. If not, `<sge_qc>` will be `raw`.

### (1) (Filtered) Transcript-indexed SGE in a FICTURE-compatible Format 
**Description**: If polygon-filtering based on UMI density is required, a filtered transcript-indexed SGE in the FICTURE format will be generated. Otherwise, this step returns a symbolic link to the input transcript-indexed SGE. 

**File Naming Convention**: 
```
<unit_id>.<solo_feature>.<feature_and_polygon_filtering>.transcripts.tsv.gz
```

**File Format**:
```
#lane  tile  X      Y        gene_id             gene    gn  gt  spl  unspl  ambig
1      1     5982   1439022  ENSMUSG00000029368  Alb     1   1   1    0      0
1      1     8173   6863206  ENSMUSG00000053907  Mat2a   1   1   0    0      0
1      1     8729   6830792  ENSMUSG00000037071  Scd1    1   1   1    0      0
```

 * `#lane`: lane ID
 * `tile`: tile ID
 * `X`: X-coordinate
 * `Y`: Y-coordinate
 * `gene_id`: Gene Ensemble ID
 * `gene`: Gene symbol
 * `gn`: the count per gene per barcode for Gene
 * `gt`: the count per gene per barcode for GeneFull
 * `spl`: the count per gene per barcode for Spliced
 * `unspl`: the count per gene per barcode for Unspliced
 * `ambig`: the count per gene per barcode for Ambiguous

### (2) A (Filtered) Tab-delimited Feature File
**Description**: If polygon-filtering based on UMI density is required, a filtered tab-delimited feature file will be generated. Otherwise, this step returns a symbolic link to the input feature file. 

This include a feature file (`*.feature.tsv.gz `) that contains information for all features and another feature file (`*.feature.clean.tsv.gz `) that contains information for features aftering the gene-filtering.

**File Naming Convention**:
```
<unit_id>.<solo_feature>.<sge_qc>.feature.tsv.gz 
```

**File Format**:
Those two feature files share the same format:

```
gene_id             gene     gn    gt   spl  unspl  ambig
ENSMUSG00000100764  Gm29155  3     3    1    0      2
ENSMUSG00000100635  Gm29157  0     0    0    0      0
ENSMUSG00000100480  Gm29156  0     0    0    0      0
```

 * `gene_id`: Gene Ensemble ID
 * `gene`: Gene symbol
 * `gn`: the count per gene per barcode for Gene
 * `gt`: the count per gene per barcode for GeneFull
 * `spl`: the count per gene per barcode for Spliced
 * `unspl`: the count per gene per barcode for Unspliced
 * `ambig`: the count per gene per barcode for Ambiguous


### (3) A Metadata File for X Y Coordinates
**Description**: This file contains the minimum and maximum X Y coordinates in micrometers.

**File Naming Convention**:
```
<unit_id>.<solo_feature>.<sge_qc>.coordinate_minmax.tsv
```

**File Format**:
```
xmin    -27.973391144511698
xmax    8699.068916753664
ymin    -26.25
ymax    5133.75
```

- `xmin`: The minimum x-coordinate in micrometers across all barcodes in the SGE.
- `xmax`: The maximum x-coordinate in micrometers across all barcodes in the SGE.
- `ymin`: The minimum y-coordinate in micrometers across all barcodes in the SGE.
- `ymax`: The maximum y-coordinate in micrometers across all barcodes in the SGE.


## Output Guidelines
The output file could be used as the input for [FICTURE](https://seqscope.github.io/ficture/).

## Parameters
```yaml
downstream:               
 sge_qcsity_filter:          
   radius: 15               
   hex_n_move: 1            
   polygon_min_size: 500    
   quartile: 2
```

* **The `radius` Parameter**
The radius refers to the circumradius (the radius of the circumscribed circle around the polygon). The radius will be used to calcualte the polygon diameter as well as the polygon area.

* **The `hex_n_move` Parameter**
Define n moves when collapse to polygon. When `hex_n_move` is 1, non-overlapping polygons will be applied. Otherwise, use overlapping polygons.

* **The `polygon_min_size` Parameter**
If provided, remove small and isolated polygons (squared um)

* **The `quartile` Parameter**
Specify which quartiles of the data should be considered for polygon-filtering. The `quartile` will be used to define the strict density cutoff. The `quartile` have four options: 0, 1, 2, 3, which corresponds to minimal, first quartile, median, and third quartile.

## Dependencies
Given `sdgeAR_polygonfilter` requires input from Rule `sdge2sdgeAR`, `sdgeAR_reformat`, and `sdgeAR_featurefilter`, Rule `sdgeAR_polygonfilter` can only execute after those three and their prerequisite rules have successfully completed. See an overview of the rule dependencies in the [Workflow Structure](../../home/workflow_structure.md).

## Code Snippet
The code for this rule is provided in [`c03_sdgeAR_polygonfilter.smk`](https://github.com/seqscope/NovaScope/blob/main/rules/c03_sdgeAR_polygonfilter.smk).
